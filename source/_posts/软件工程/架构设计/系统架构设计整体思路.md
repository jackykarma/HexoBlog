---
title: 系统架构设计整体思路
date: 2022-09-16 07:04:39
tags: 架构设计
categories: 软件工程
---

> > 架构设计就是让一个复杂的系统黑箱，通过一些列的**理性的**思考、设计方法手段，让其逐渐变为灰箱、白箱的过程。它是一门解决复杂问题的艺术。

架构师经常面对的实践困惑。其中，涉及了“几个实际问题的困惑”，以及“两个职业发展的困惑”。

| 类型        | 困惑                                                                           |
| --------- | ---------------------------------------------------------------------------- |
| 实际问题的困惑   | 1. 大系统架构设计，如何起步？                                                             |
|           | 2. 大型系统如何拆分为子系统，子系统又如何合理的拆分为组件或模块，组件或模块内部又如何识别出支撑模块功能的类和接口，这些有具体的方法或思路可以遵循吗？ |
|           | 3. 总觉得需求很糟糕，影响了设计？                                                           |
|           | 4. 非功能需求很重要，但如何来设计？                                                          |
|           | 5. 从需求分析到详细架构输出，这中间巨大的鸿沟可以用理性、有分析步骤的推导出来吗？                                   |
| 两个职业发展的困惑 | 1. 架构新手：缺乏指导，架构设计 不知所措！                                                      |
|           | 2. 架构老手：缺乏总结，没有形成方法体系，仍怕下个项目！                                                |

## 一、架构的基本认识

### 1.1. 架构定义

关于架构的定义又多又乱。但是主要分为两大派：

1. 组成派：软件系统的架构将系统描述为计算组件及组件之间的交互。这里的“计算组件”是泛指，可以指子系统、框架、模块、类等不同粒度的软件单元。组成派认为**架构 =  组件 + 交互**。它关注架构实践中的客体——软件，以软件本身为描述对象。分析了软件的组成，即软件由承担不同计算任务的组件组成，这些组件通过相互交互完成更高层次的计算。

2. 决策派：软件架构是在一些重要方面所做出的决策的集合。包含：
	- 软件系统的组织；
	- 选择组成系统的结构元素和他们之间的接口，以及当这些元素相互协作时所体现的行为；
	- 如何组合这些元素，使他们逐渐合成为更大的子系统；
	- 用于指导这个系统组织的框架风格：这些元素以及它们的接口、协作和组合。
	- 软件架构并不仅仅注重软件本身的结构和行为，还注重其他特性：使用、功能性、性能、弹性、重用、可理解性、经济和技术的限制及权衡，以及美学等。

综合下，架构概念包含两个方面：

1. 软件架构关注分割与交互：架构设计是分与合的艺术。组成派从软件组成的角度解析了软件架构的要素：组件及组件之间的交互。因此，从这个角度出发看，软件架构设计的关键就是**计算组件分解以及确定计算组件之间的交互方式**。
2. 软件架构是一系列**有层次的决策**：架构属于设计，但并非所有设计都属于架构。架构涉及的决策，往往对**整体质量、并行开发、适应变化**等方面有着重大影响：
	- 系统、子系统、模块如何划分？
	- 每个系统、子系统、模块的职责是什么？
	- 每个组件的接口如何定义？
	- 组件如何通信、采用何种交互机制？
	- 开发技术如何选型？
	- 如何满足约束和质量属性的需求？
	- 如何适应可能发生的变化？
	- ……

架构设计过程是分层次依次展开的——无论是决策如何切分系统还是决策技术选型都是如此。 比如：顶层设计（系统设计）-\> 系统（若可以分的话）-\> 子系统设计 -\> 模块设计 -\> 类文件设计 -\> 方法设计。

![](%E6%88%AA%E5%B1%8F2022-06-19%2011.20.11.png)

> > 架构设计过程就是让一个复杂的系统黑箱，通过一些列的思考、设计方法手段，让其逐渐变为灰箱、白箱的过程。

### 1.2. 软件架构为谁而设计

1. 程序员说，软件架构就是要决定需要编写哪些C程序或OO类、使用哪些现成的程序库（Library）和框架（Framework）。程序经理笑了。
2. 程序经理说，软件架构就是模块的划分和接口的定义。系统分析员笑了。
3. 系统分析员说，软件架构就是为业务领域对象的关系建模。
4. 配置管理员笑了。配置管理员说，软件架构就是开发出来的以及编译过后的软件到底是个啥结构。
5. 数据库工程师笑了。数据库工程师说，软件架构规定了持久化数据的结构，其他一切只不过是对数据的操作而已。
6. 部署工程师笑了。部署工程师说，软件架构规定了软件部署到硬件的策略。用户笑了。
7. 用户说，软件架构应该将系统划分为一个个功能子系统。程序员又笑了。

大家都没错呀，所有这些方面都是需要的啊。

### 1.3. 架构粒度

未必是完整的软件系统才有架构，真实的软件其实是“由组件**递归**组合而成”的：

1. 粒度多样性：组件的粒度可以很小，也可以很大：任何粒度的组件都可以组合成粒度更大的整体。
2. 粒度相对性：组件粒度的界定，必须在具体的实践上下文中才有意义：你的大粒度组件，对我而言可能是原子组件。、
3. 组件分为原子组件和复合组件两种。原子组件是不可再分的，复合组件是由其他组件组合而成的。

系统、子系统、模块的识别方法：

1. 系统：系统是一个可以**独立承载某类业务功能的完整实体**，由一组完成特定任务的功能组成。一般来说有如下特征：
	- 一个系统有独立完整的应用系统架构，包括业务接入、逻辑处理、信息存储等能力；
	- 一个系统有明确的系统部署边界，有独立的数据、应用等服务器节点，特殊情况下的硬件共享除外（此种情况下，技术上具备拆分部署能力，仅从其他方面考虑按硬件共享方式部署）。
2. 子系统：子系统和系统是**相对的**，从管理实践来说，符合系统定义和特征的，建议归入系统。而如果特定范畴内存在多个系统，这些**系统之间耦合度较高**，**对外暴露的业务或系统功能接口相对统一**，那么这个特定范畴建议作为“系统”进行管理，这个特定范畴之内的系统作为“子系统”进行管理。
3. 组件：Component，中文称为组件，或者构件。使用非常比较广泛，它的核心意义在于复用，相对模块，对于依赖性有更高的要求。从设计上来看，组件强调复用，模块强调职责(内聚、分离)，或者说组件是达到可复用要求的模块。Component-Based Software Development中提倡的组件定义如下(Component Software): 除了完成某个特定功能外，还要具备如下条件的代码组合:
	- 符合特定的接口要求（交互的要求）。
	- 具有明确的上下文依赖 （复用的要求）。
	它可以独立发布(二进制或源代码的形式)，也可以进行组合。这样软件开发就变成了组件的组装了。和OOP中的Objects相比，**一个类也可以视为一个组件，但更多的情况下，组件提供了更为高层的系统视角**。Component如同一片树林，Object只是树。

	两者的关系取决于软件本身和视角。Eclipse框架下的一个插件可能包含若干个模块，因为从Eclipse的角度来看，每个Plugin是用来复用的。而一个应用的模块(如GUI)下也可能使用了多个组件，因为复用的是每个控件。

	另外也有人从发布形式上来区分，其实也不尽然。一个模组可能以静态库、动态库存在(skia被应用到一个应用中的场景)，一个组件也可能以源码的形式存在(Chromium中的Browser Component)。发布形式其实是取决于产品需求的，不可能准确的区分出两个设计上的概念。
4. 模块：Module, 中文为模块或模组。它的核心意义是分离职责，属于代码级模块化的产出。本身是一组具有一定内聚性代码的组合，职责明确。对外的接口可以是松散的，也可以是集中的。SEI的定义：An implementation unit of software that provides a coherent set of responsibilities. 它以问题分解的形式，来解决软件设计问题。它更强调一个内聚的概念，形式上可以是Java中的包，也可以是一个源代码目录。
	- 区别于系统/子系统，模块一般不单独部署；
	- 不独立运行；
	- 一般用于代码开发管理，对运行维护人员透明。

### 1.4. 架构与框架

框架可以通过某种回调机制进行扩展的软件系统或子系统的**半成品**（典型的如Android系统的framework）。**框架是半成品，这是它的本质所在。**

“软件重用”存在一对内在矛盾：“重用几率”大小和“重用带来的价值量”大小。简言之，软件单元的粒度越大，则重用所带来的价值量越大，但重用几率越小；反之，粒度小的软件单元被重用的几率大，但重用所带来的价值量小。

框架的智慧就在于此：为了追求重用所带来的价值量最大化，**将容易变化的部分封装成扩展点，并辅以回调机制将它们纳入框架的控制范围之内，从而在兼顾定义开销的同时使被重用的设计成果最多**。

通用机制框架化，对于架构牢固性而言，是不可或缺的。框架之于整个软件系统，就好比一座大厦的供暖、供电、排水等设施，着重解决整座大厦的不少通用问题。

### 1.5. 架构设计的原则

三个原则：

1. 研究透需求：这是基础。架构师可能不是“需求”和“领域模型”的负责人，但也必须深入了解。架构是基于业务模型的，是服务于业务、赋能业务的，抛开业务搞架构设计就是耍流氓。
2. 保证架构大方向的正确：“关键需求” 决定 “概念架构”。架构的大方向都不对，后续的所有设计都是走在错误的道路上，越走越远。
3. 设计好架构的各个方面：充分设计架构的各个方面，通过多视图方法“细化架构”，通过“架构原型”验证架构，**不断迭代优化架构的各个方面。**

![](%E6%88%AA%E5%B1%8F2022-04-05%2011.33.23.png)

### 1.6. 架构设计的目标

架构设计的主要目的是为了解决软件系统复杂度带来的问题。架构设计是解决复杂系统问题的一种手段，通过将复杂的系统问题，拆分为子问题，从而更好的解决问题。**软件架构设计是要完成从面相问题到面相解决方案的转换，切分结构、定义协作、选择技术……**

因此，要明确“架构设计是为了解决软件复杂度”的原则。基于此原则来决策面对的问题。比如：

1. “这么多需求，从哪里开始下手进行架构设计呢？” ——通过熟悉和理解需求，识别系统复杂性所在的地方，然后针对这些复杂点进行架构设计。
2. “架构设计要考虑高性能、高可用、高扩展……这么多高XX，全部设计完成估计要1个月，但老大只给了1周时间”——架构设计并不是要面面俱到，不需要每个架构都具备高性能、高可用、高扩展等特点，而是要识别出复杂点然后有针对性地解决问题。
3. “业界A公司的架构是X，B公司的方案是Y，两个差别比较大，该参考哪一个呢？”——理解每个架构方案背后所需要解决的复杂点，然后才能对比自己的业务复杂点，参考复杂点相似的方案。

遵循这条准则能够让架构师**有的放矢，而不是贪大求全**。

更具体一点来讲，架构设计的目的就是：

1. 做事情正确的方法，应该是从粗到细、层层递进，紧紧抓住主要矛盾，防止出现方向性错误，搞的满盘皆输，浪费时间和资源；实际上很多微观的问题都是宏观问题的一个投影。架构设计的过程，是层层分解的过程，实际上这是人类做事的重要方法论，一个大问题往往需要综合各个方面的能力才可以解决，但是很少有一个人具备这么多能力，经过分解后，把大问题变成小问题，就很容易找到合适的人来解决，这个在很大程度上提高了效率。
2. 分解问题，聚焦问题，降低问题的复杂性，因为人脑的处理能力是有限的，我们之所以有的时候需要借助模型，模型本身就是一个对实际目标的抽象，就是为了忽略一些无关紧要的影响，以此来照顾我们“不够聪明的大脑”；隔离问题，便于管理；这些问题来自于功能性需求、质量需求（吞吐量、响应速度、高可用、可扩展、易用性等等），以及其他非功能性需求，比如工期要求、比如硬件环境要求，再比如开发过程中在大量人员介入后，不要出现瓶颈问题。我们关注的问题，就是我们要重点关注和需要采取手段的地方。
3. 居高临下，宏观上统筹规划；排任务优先级，防止出现瓶颈，做到风险前移。理清系统边界、挖掘潜在需求。比如，我们通过建模能够发现关键模块和路径，可以提前在较粗的颗粒度上完成验证，即使出现方案失败，也发生在大量资源投入之前，最大程度减少浪费；
4. 提取通过用功能、降低开发工作量。重复是软件的大忌。

> > 架构设计的过程并不是一步到位的，而不是在细化设计的过程中不断发现新的问题，然后不断修正设计、完善设计的过程。就像解决问题的过程并不是发现问题-\>分析问题-\>解决问题。而是发现问题-\>分析问题-\>发现新的问题-\>解决问题-\>发现新的问题…-\>解决问题-\>…

## 二、掌握架构设计的关键

1. 明白方法体系是大趋势
2. 以质疑来驱动的架构设计
3. 掌握多阶段方法
4. 实践+理论反复训练、反思、总结

### 2.1. 方法体系

关于架构设计，形成个人的方法体系是非常重要的，不能纸上谈兵。实际架构设计要基于业务模型来考虑，脱离业务谈架构就是耍流氓，所以架构师是理论结合实践的最佳践行者。单一方法已经无法解决复杂的业务需求，一线架构师真正需要的是覆盖“**需求进，架构出**”全过程的实践指导。

**设计是理性的，决不能靠拍脑袋来决策**，即便是美的设计也是有设计原则遵循的，软件架构设计也一样。如果每次设计软件系统，全靠经验和感觉来设计，那么这样的系统是存在诸多风险的，尤其是大型系统的设计。

### 2.2. 以质疑来驱动设计

毫无疑问，架构设计是需求驱动的，而不是模型驱动的。但需求驱动的说法，不太传神——当你很清楚需求却依然设计不出架构时就足以 说明“需求驱动的架构设计”的总结还“缺点儿什么”。

架构设计是一门艺术，你不可能把“一桶需求”倒进某台神奇的机器然后等着架构设计自动被“加工生产”完毕，**因此“需求驱动的架构设计”给架构师的启发不够**。缺点儿什么呢? 答案是，缺“人的因素”、“架构师的因素”! 因此架构设计实际上是个“质疑驱动的过程”: **需求，被架构师的大脑(而不是自动)，有节奏地引入到架构设计的一波接一波的思维活动中**。

例如，作为架构师，当你的架构设计进行到一半时，你可以明显感觉到:这个架构设计中间成果，还需要“我”进一步通过“质疑”引入更多“质量属性”以及“特殊功能场景”来驱动后续的架构设计工作的开展。质疑意识，是架构师最宝贵的意识之一。

### 2.3. 认识到架构设计是分多阶段、分层次、增量进行、不断质疑迭代改进

架构设计的多视图方法很重要，但是，架构设计方法首先当是多阶段的，其次才是多视图的。一句话，先做后做--这叫阶段（Phase）,齐头并进--这叫视图(View)。     

架构设计的三个阶段：

1. Pre-architecture阶段：需求分析、领域建模 、确定关键需求（1、2、3步骤）
2. Conceptual Architecture阶段：关键需求决定概念架构。（4步骤概念架构只关注高层）
3. Refined Architecture阶段: 落地的5视图方法（5步骤细化架构、6架构验证）

架构设计也是分层次展开的，从高层到底层（系统-\>子系统-\>组件或模块）；架构设计中涉及的设计过程通常都是增量进行的，不断迭代和完善的，并不是一蹴而就的。

![](DraggedImage.png)

### 2.4. 理论结合实践

方法不应该是个空框框，应融入最佳实践经验。架构师不能纸上谈兵，架构之所以难就是因为它需要理论结合实践，最终给出优秀的设计方案，帮助解决复杂的系统问题。只会理论的架构师设计出的东西是空洞，无法真正解决实际问题。因此要成为优秀的架构师，那么就需要深入一线，去熟悉业务，熟悉技术，不断从项目实践中获得成长，总结经验。

## 三、大型系统架构设计

![](DraggedImage-1.png)

对于大型复杂系统，按照以上的3阶段、分层次，进行增量设计。

### 3.1. 第一阶段

需求捕获与需求分析：

![](%E6%88%AA%E5%B1%8F2022-04-05%2012.03.38.png)
![](%E6%88%AA%E5%B1%8F2022-04-05%2011.46.19.png)

通过与需求相关人员沟通、查看需求文档，从而确定系统目标、需求范围、Feature拆分、建立系统上下文图、建立系统的高层用例模型、建功能、质量、约束的需求矩阵。

### 3.2. 第二阶段：概念架构设计

关键需求决定架构。目标错误比遗漏需求更糟糕。关键需求决定架构，其余需求验证架构。有经验的架构师知道，花精力去明确对架构设计影响重大的关键需求非常值得。

确定关键功能需求的方式是，通过下面4条启发规则，确定关键功能子集：

1. 核心功能：有个标志：业务层的接口要反映这些功能。
2. 必做功能：主要依据客户方的背景。
3. 高风险功能：及早将高风险功能纳入关键功能，有利于有针对性地进行架构设计；
4. 独特功能

确定关键质量需要做如下三个方面工作：

1. 考虑为了提高开发的软件系统受认可的程度，应着重提高哪些方面的质量属性要求；
2. 接下来，充分考虑这些质量属性的相互制约或相互促进关系，以调整不同质量属性的要求标准——例如，你可能会决定高性能要求最最重要，而可扩展性也比较重要；
3. 同时，必须满足各种约束性需求。

开始概念架构的设计：概念架构设计的层次和粒度是顶层系统。它不考虑模块或组件、接口之类的更低层次设计的细节。

![](%E6%88%AA%E5%B1%8F2022-04-05%2012.27.47.png)

![](%E6%88%AA%E5%B1%8F2022-04-05%2012.22.16.png)

依据高层用例模型（高层需求），使用鲁棒图识别高层对象，可用鲁棒图（本质是类图）或类图绘制出高层领域模型。鲁棒图帮助进行领域模型的建立。在概念架构设计步骤，主要针对的是系统顶层的领域建模，帮助识别出高层领域对象。

概念架构设计中，领域建模可以识别和划分顶层子领域，帮助识别高层领域对象，这些高层领域对象不一定就是可以顶级子系统划分一一对应。因此还需要从开发者角度对系统进行分解，结合高层领域模型划分出顶级子系统。顶层子系统或组件的分层架构也可以展示出来。

其次，概念架构设计阶段，要明确架构风格选型、开发技术选型、集成技术选型、二次开发技术选型，确立架构的大方向。

> > 领域建模DDD在面向对象的软件体系架构中，从在不同level都参与领域建模过程，它是划分问题领域、识别领域对象的非常实用且关键的方法。

### 3.3. 第三阶段：细化架构设计

细化架构和概念架构之间存在如下典型差异：

1. 接口：在细化架构中接口占据非常核心的地位，而概念架构并不明确接口定义（只有抽象的组件和抽象的交互机制）。
2.  子系统：细化架构重视通过子系统和模块来分割整个系统，并且子系统往往有明确的接口；而概念架构中只有抽象的组件，这些**组件没有接口，只有职责（领域对象，而不是开发对象）**，一般是处理组件、数据组件和连接组件中的一种。当然，概念架构中也有“大组件分解成小组件”的设计决策，但并非子系统的含义。
3. 交互机制：细化架构中的交互机制应是“实在”的，如基于接口编程、消息机制或远程方法调用等；而概念架构中的交互机制是“概念化”的。例如“A层使用B层的服务”就是典型的例子，这里的“使用”到了细化架构中可能基于接口编程、消息机制或远程方法调用等其中的一种。

![](%E6%88%AA%E5%B1%8F2022-06-25%2021.43.00.png)

从图中可以看出：

1. 概念架构、细化架构属于系统架构设计，系统架构设计提供架构规约，从5种架构视图的角度来明确规范。
2. 开发实现：包括详细设计与编码实现，并不属于系统架构设计的方法论范畴，它们是基于系统架构设计提供的规约来进行详设计和编码实现。**先进行架构设计，后进行详细设计和编码实现**。

细化架构设计从5个视图角度来看，要包含15个设计任务：

![](%E6%88%AA%E5%B1%8F2022-04-05%2012.36.33.png)

分层次进行增量设计：以逻辑架构视图为例

1. 从概念架构设计阶段，我们可以得到一个高层的领域对象模型。我们可以基于高层的领域对象模型和领域对象时序图，从开发层面进行分解，将业务对象转化为开发子系统。同时，将系统进行分层、并分为多个子系统。
2. 针对每个子系统再走一次上述的流程：基于子系统建立用例模型，然后借助鲁棒图和DDD设计得到子系统内部的领域模型，然后再从开发层面进行分解，将子系统内部的业务对象转化为子系统内部的开发组件。如此，完成所有子系统的内部分解。
3. 针对每个子系统内部的组件或模块进行设计：利用设计模式、组件内用例分析和DDD等确定组件内部实现所需的类、接口等，以真正指导和落地开发。

其他视图的风层次增量设计思路类似。

> > 这里存在一个问题：就是系统分解往往是在较低层次的对象确定后，才可以根据对象的时序图（协作关系）分清组件或模块或类应该位于哪个层次和哪个子系统更合适。如果按部就班的从高层逐步到低层来设计，可能存在系统分解不合理的情况，因为高层不涉及系统，因此问题未必能想的清楚。所以设计的过程可能是从高层到低层，然后低层发掘更多高层不可知的细节后，又反过来指导高层系统的集成与分解。

**需求分析中领域建模与下面的概念架构中运用鲁棒图识别高层对象是否是重复过程？领域建模DDD是适合面向对象的，用于识别对象的好方法，但是从更大的层面来看，系统架构设计还涉及到不同类型系统的设计（非OO的系统架构）、系统质量等考虑因素，因此DDD在整个软件架构设计方法论中，应该只是面向对象组件或模块设计的最佳方法，而并非是系统架构设计中的最佳方法。**

## 四、组件架构设计

组件架构设计直接从需求分析开始，然后第二阶段可以选择跳过，也可以不跳过，接着开始第三阶段的第三个层次的设计工作即可。可以理解为组件架构设计流程是大型复杂系统架构设计的一个子集。

![](%E6%88%AA%E5%B1%8F2022-09-16%2007.01.27.png)![](%E6%88%AA%E5%B1%8F2022-09-16%2007.01.39.png)
![](%E6%88%AA%E5%B1%8F2022-09-16%2007.01.16.png)

